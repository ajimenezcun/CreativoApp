<div
    class="code-block-container absolute right-0 top-0 z-10"
    id="svg-container"
>
    <div class="glow-effect"></div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("svg-container");

        // Usamos offsetWidth/Height para asegurar dimensiones correctas
        const width = container.offsetWidth;
        const height = container.offsetHeight;

        // Configuración de la cuadrícula
        const fontSize = 14;
        const charSpacing = 14;
        const lineHeight = 22;

        const cols = Math.floor(width / charSpacing);
        const rows = Math.floor(height / lineHeight);

        const charSet = "01abcdefx_{}[]<>/!@#=$%&*+?|:;";

        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "100%");
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.style.position = "relative";
        svg.style.zIndex = "10";
        svg.classList.add("svg-content"); // Aplica la máscara gradiente

        container.appendChild(svg);

        let gridElements = [];

        // Generar la cuadrícula
        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                // Densidad del 75%: saltamos el 25%
                if (Math.random() > 0.75) continue;

                const text = document.createElementNS(svgNS, "text");
                const char = charSet.charAt(
                    Math.floor(Math.random() * charSet.length),
                );

                // Centrado
                const x = c * charSpacing + charSpacing / 2;
                const y = r * lineHeight + fontSize;

                text.setAttribute("x", x);
                text.setAttribute("y", y);
                text.textContent = char;

                // Color base: Slate 600 (#475569) para que sea sutil contra el fondo oscuro
                text.setAttribute("fill", "#475569");
                text.setAttribute("font-family", "'Fira Code', monospace");
                text.setAttribute("font-size", fontSize);
                text.setAttribute("opacity", Math.random() * 0.4 + 0.1); // Opacidad baja por defecto

                svg.appendChild(text);
                gridElements.push(text);
            }
        }

        function animate() {
            // Actualizamos aprox el 1.5% de caracteres por frame
            const updatesPerFrame =
                Math.floor(gridElements.length * 0.015) || 1;

            // Fase 1: Activar (Glitch azul/blanco)
            for (let i = 0; i < updatesPerFrame; i++) {
                const randomIdx = Math.floor(
                    Math.random() * gridElements.length,
                );
                const el = gridElements[randomIdx];

                el.textContent = charSet.charAt(
                    Math.floor(Math.random() * charSet.length),
                );

                // Color Cyan brillante
                el.setAttribute("fill", "#38bdf8");
                el.setAttribute("opacity", "0.9");
            }

            // Fase 2: Enfriar (Volver a gris oscuro)
            for (let i = 0; i < updatesPerFrame * 2.5; i++) {
                const randomIdx = Math.floor(
                    Math.random() * gridElements.length,
                );
                const el = gridElements[randomIdx];

                if (el.getAttribute("fill") === "#38bdf8") {
                    el.setAttribute("fill", "#475569");
                    el.setAttribute("opacity", Math.random() * 0.4 + 0.1);
                }
            }

            requestAnimationFrame(animate);
        }

        animate();
    });
</script>
